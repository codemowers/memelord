{% load static i18n %}
{% load extras %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}">
<head>
    <link href="{% static 'assets/img/favicon.ico' %}" rel="shortcut icon">
    <link href="{% static 'assets/img/apple-touch-icon.png' %}" rel="apple-touch-icon">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        {% block title %}MemeLord{% endblock %}
    </title>

    <script>
      (function() {
        const storageKey = "memelord-theme";
        const root = document.documentElement;
    
        try {
          const saved = localStorage.getItem(storageKey);
          if (saved === "light" || saved === "dark") {
            root.setAttribute("data-bs-theme", saved);
            return;
          }
        } catch (e) {
          // localStorage might be blocked, ignore and fall back
        }
    
        // Fallback: system preference
        const prefersDark = window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        root.setAttribute("data-bs-theme", prefersDark ? "dark" : "light");
      })();
    </script>   

    <!-- Bootstrap 5 from CDN (5.3+ supports color modes) -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous"
    >

    <style>
      /* Navbar theming: always dark, but slightly lighter in dark mode */
      .navbar-main {
        transition: background-color 0.2s ease;
      }
    
      html[data-bs-theme="light"] .navbar-main {
        background-color: #212529; /* classic bg-dark */
      }
    
      html[data-bs-theme="dark"] .navbar-main {
        background-color: #2f343a; /* a bit lighter than full dark for contrast */
      }
    
      /* Space for fixed navbar so content isn't hidden underneath */
      body {
        padding-top: 72px; /* tweak if your navbar is taller/shorter */
      }
    
      @media (max-width: 575.98px) {
        /* a bit more space on very small screens where navbar might wrap */
        body {
          padding-top: 82px;
        }
      }
    
      /* Make sure content doesn't hide behind fixed footer */
      main {
        padding-bottom: 3rem; /* reserve space roughly equal to footer height */
      }
    
      /* Meme cards: different lower section in dark mode */
      .meme-card-body {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
      }
    
      html[data-bs-theme="light"] .meme-card-body {
        background-color: #ffffff;
      }
    
      html[data-bs-theme="dark"] .meme-card-body {
        background-color: #1f2329;  /* slightly darker panel under the thumbnail */
        border-top-color: rgba(255, 255, 255, 0.08);
      }
    
      /* Sticky meme list toolbar (title + tag filter + upload button) */
      :root {
        --navbar-height: 72px;
      }
    
      .meme-toolbar-sticky {
        position: sticky;
        top: 65px;
        z-index: 1020;
        background-color: var(--bs-body-bg);
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }
    
      html[data-bs-theme="dark"] .meme-toolbar-sticky {
        border-bottom-color: rgba(255, 255, 255, 0.08);
      }   
      
      /* Footer styling: FIXED at bottom, dark in light theme, slightly lighter in dark */
      .footer-main {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1030;
        font-size: 0.8rem;          /* compact */
      }

      html[data-bs-theme="light"] .footer-main {
        background-color: #212529;  /* match light-theme navbar */
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        color: #f8f9fa;
      }

      html[data-bs-theme="dark"] .footer-main {
        background-color: #2f343a;  /* match dark-theme navbar tone */
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        color: #f8f9fa;
      }

      .footer-main a {
        color: inherit;
        text-decoration: none;
      }

      .footer-main a:hover {
        text-decoration: underline;
      }

      /* Background under meme on detail page */
      html[data-bs-theme="light"] .meme-media-body {
        background-color: #f8f9fa; /* light grey, works with transparent PNGs */
      }

      html[data-bs-theme="dark"] .meme-media-body {
        background-color: rgba(var(--bs-body-bg-rgb),var(--bs-bg-opacity)) !important; /* keep it properly dark in dark mode */
      }

      html[data-bs-theme="light"] .meme-thumb-body {
        background-color: #f8f9fa;
      }

      html[data-bs-theme="dark"] .meme-thumb-body {
        background-color: rgba(var(--bs-body-bg-rgb),var(--bs-bg-opacity)) !important
      }

      /* Quick-view overlay background per theme */
      html[data-bs-theme="light"] #meme-quick-view {
        background-color: rgba(160, 160, 160, 0.97);  /* light grey, fits light theme */
      }

      html[data-bs-theme="dark"] #meme-quick-view {
        background-color: rgba(15, 15, 17, 0.97);     /* your current dark background */
      }
      
    </style>  

    {% block extra_head %}{% endblock %}
</head>
<body class="bg-body text-body d-flex flex-column min-vh-100">

  <nav class="navbar navbar-expand-lg navbar-dark navbar-main fixed-top">
    <div class="container-fluid">
        <div style="margin-right: 5px" class="logo-container">
            <a href="/"><img title="" height="50" width="50" src="{% static 'assets/img/logo.png' %}" alt="MemeLord logo"></a>
        </div>
        <a class="navbar-brand" href="{% url 'myapp:meme_list' %}">
            MemeLord
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#mainNavbar" aria-controls="mainNavbar"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'myapp:meme_list' %}">
                        Feed
                    </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'myapp:meme_random' %}">
                      Randomizer
                  </a>
              </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'myapp:meme_upload' %}">
                        Upload
                    </a>
                </li>
            </ul>

            <div class="d-flex align-items-center gap-2">
                {% if request.user.is_authenticated %}
                    <!-- username is always leftmost on the right side -->
                    <span class="navbar-text me-1">
                        {{ request.user }}
                    </span>

                    {% if request.user.is_superuser %}
                        <a class="btn btn-outline-warning btn-sm" href="{% url 'admin:index' %}">
                            Admin
                        </a>
                    {% endif %}

                    {% if not "OIDC_ENABLED"|env %}
                        <a class="btn btn-outline-light btn-sm"
                           href="{% url 'password_change' %}"
                           title="{% trans 'Change Password' %}">
                            üîë
                        </a>
                    {% endif %}                    

                    <!-- Theme toggle next to Admin -->
                    <button type="button"
                            class="btn btn-outline-light btn-sm"
                            id="theme-toggle"
                            aria-label="Toggle light/dark mode">
                        üåô
                    </button>

                    <form method="post"
                          action="{% if 'OIDC_ENABLED'|env == True %}{% url 'oidc_logout' %}{% else %}{% url 'logout' %}{% endif %}"
                          class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-light btn-sm">
                            Logout
                        </button>
                    </form>
                {% else %}
                    <!-- Not authenticated: keep toggle and login -->
                    <button type="button"
                            class="btn btn-outline-light btn-sm me-1"
                            id="theme-toggle"
                            aria-label="Toggle light/dark mode">
                        üåô
                    </button>
                    <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">
                        Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<main class="container pt-3 pb-4 flex-grow-1">
    {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% block content %}{% endblock %}
</main>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
></script>

<script>
  (function() {
    const storageKey = "memelord-theme";
    const root = document.documentElement;

    function getCurrentTheme() {
      const attr = root.getAttribute("data-bs-theme");
      return (attr === "dark" || attr === "light") ? attr : "light";
    }

    function applyTheme(theme) {
      root.setAttribute("data-bs-theme", theme);
      try {
        localStorage.setItem(storageKey, theme);
      } catch (e) {
        // ignore storage errors
      }

      const toggleBtns = document.querySelectorAll("#theme-toggle");
      toggleBtns.forEach(btn => {
        btn.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      });
    }

    // Sync icons with whatever the head script decided
    applyTheme(getCurrentTheme());

    const toggleBtns = document.querySelectorAll("#theme-toggle");
    toggleBtns.forEach(btn => {
      btn.addEventListener("click", function() {
        const current = getCurrentTheme();
        const next = current === "dark" ? "light" : "dark";
        applyTheme(next);
      });
    });
  })();
</script>

<footer class="footer-main">
  <div class="container py-1 d-flex flex-column flex-md-row justify-content-between align-items-center gap-1">
    <div class="small">
      <strong>MemeLord</strong>
      {% with "VERSION"|env as app_version %}
        {% if app_version %}
          <a href="https://github.com/l4rm4nd/MemeLord/releases/tag/v{{ app_version }}">
            <span class="ms-1">v{{ app_version }}</span>
          </a>
        {% endif %}
      {% endwith %}
    </div>
    <div class="small text-md-end">
      Built by
      <a href="https://github.com/l4rm4nd">LRVT</a>
      <span class="d-none d-md-inline">¬∑</span>
      <span class="d-inline text-nowrap">Made with ‚ù§Ô∏è</span>
    </div>
  </div>
</footer>

{% block extra_js %}{% endblock %}
</body>
</html>