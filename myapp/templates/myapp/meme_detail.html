{% extends "myapp/base.html" %}
{% load static %}

{% block title %}{{ media.title|default:"Meme" }}{% endblock %}

{% block content %}
{# Row 1: Meme card full width #}
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        {% if request.user == media.uploader or request.user.is_superuser %}
        <h1 class="h5 mb-0" id="meme-title-display">
          {{ media.title|default:"Untitled meme" }}
          <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="edit-title-btn">
            Edit
          </button>
        </h1>
        <form method="post" action="{% url 'myapp:meme_update_title' media.pk %}" class="d-none" id="title-edit-form">
          {% csrf_token %}
          {{ title_form.title }}
          <button type="submit" class="btn btn-sm btn-primary">Save</button>
          <button type="button" class="btn btn-sm btn-secondary" id="cancel-title-btn">Cancel</button>
        </form>
        {% else %}
        <h1 class="h5 mb-0">{{ media.title|default:"Untitled meme" }}</h1>
        {% endif %}

        <div>
          by {{ media.uploader }} Â· {{ media.created_at|date:"Y-m-d H:i" }}
        </div>
      </div>

      <div class="card-body">
        {# Download is shown to everyone who can see the meme #}
        <a href="{{ media.file.url }}" download class="btn btn-sm btn-outline-primary mb-2">
          Download
        </a>

        {% if request.user == media.uploader or request.user.is_superuser %}
        <form method="post" action="{% url 'myapp:meme_delete' media.pk %}" class="d-inline" onsubmit="return confirm('Are you sure?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-danger mb-2">Delete</button>
        </form>
        {% endif %}

        <div class="mt-3">
          {% if media.media_type == 'image' %}
            <img src="{{ media.file.url }}" alt="{{ media.title }}" class="img-fluid rounded">
          {% else %}
            <video controls class="w-100 rounded">
              <source src="{{ media.file.url }}" type="{{ media.file.content_type }}">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>
      </div>

      <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
          <div id="tags-display">
            {% for tag in media.tags.all %}
              <span class="badge bg-secondary">#{{ tag.name }}</span>
            {% empty %}
              <span class="text-muted">No tags assigned</span>
            {% endfor %}
            {% if request.user == media.uploader or request.user.is_superuser %}
              <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="edit-tags-btn">
                Edit tags
              </button>
            {% endif %}
          </div>

          {% if request.user == media.uploader or request.user.is_superuser %}
          <form method="post" action="{% url 'myapp:meme_update_tags' media.pk %}" class="d-none w-100" id="tags-edit-form">
            {% csrf_token %}
            <div class="position-relative">
              {{ tag_form.tags_input }}
              <div id="tag-suggestions"
                   class="position-absolute w-100 bg-body border border-secondary-subtle mt-1 rounded-3 shadow-sm d-none"
                   style="z-index: 1000;"></div>
            </div>
            <button type="submit" class="btn btn-sm btn-primary mt-2">Save tags</button>
            <button type="button" class="btn btn-sm btn-secondary mt-2" id="cancel-tags-btn">Cancel</button>
            <div class="form-text">
              Separate tags with comma. Suggestions appear while typing.
            </div>
          </form>
          {% endif %}

          {% if media.album %}
          <div>
            Album: <a href="{% url 'myapp:album_detail' media.album.pk %}">{{ media.album.title }}</a>{% if media.album.is_private %} (private){% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{# Row 2: Comments below meme, two columns on large screens #}
<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Comments ({{ comments_page.paginator.count }})</h2>
        {% if comments_page.paginator.num_pages > 1 %}
        <span class="text-muted small">
          Page {{ comments_page.number }} / {{ comments_page.paginator.num_pages }}
        </span>
        {% endif %}
      </div>
      <div class="card-body">
        {% include "myapp/partials/comments_block.html" %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">
        <h3 class="h6 mb-0">Add a comment</h3>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'myapp:meme_add_comment' media.pk %}"
          {% csrf_token %}
          {{ comment_form.text }}
          {% if comment_form.text.errors %}
          <div class="invalid-feedback d-block">
            {{ comment_form.text.errors|striptags }}
          </div>
          {% endif %}
          <button type="submit" class="btn btn-primary mt-2">Add a comment</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const tagsInput = document.getElementById("id_tags_input");
  const suggestionsBox = document.getElementById("tag-suggestions");
  const editTagsBtn = document.getElementById("edit-tags-btn");
  const cancelTagsBtn = document.getElementById("cancel-tags-btn");
  const tagsDisplay = document.getElementById("tags-display");
  const tagsEditForm = document.getElementById("tags-edit-form");

  // Disable browser autocomplete
  if (tagsInput) {
    tagsInput.setAttribute("autocomplete", "off");
    tagsInput.setAttribute("autocorrect", "off");
    tagsInput.setAttribute("autocapitalize", "off");
    tagsInput.setAttribute("spellcheck", "false");
  }

  // Tag editing toggle
  if (editTagsBtn) {
    editTagsBtn.addEventListener("click", function() {
      tagsDisplay.classList.add("d-none");
      tagsEditForm.classList.remove("d-none");
      tagsInput.focus();
    });
  }

  if (cancelTagsBtn) {
    cancelTagsBtn.addEventListener("click", function() {
      tagsDisplay.classList.remove("d-none");
      tagsEditForm.classList.add("d-none");
      suggestionsBox.classList.add("d-none");
    });
  }

  // Tag suggestions
  let suggestionTimeout = null;

  function fetchSuggestions(query) {
    if (!query) {
      suggestionsBox.classList.add("d-none");
      suggestionsBox.innerHTML = "";
      return;
    }

    const url = "{% url 'myapp:tag_suggestions' %}?q=" + encodeURIComponent(query);
    fetch(url, {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(res => res.json())
    .then(data => {
      const results = data.results || [];
      if (!results.length) {
        suggestionsBox.classList.add("d-none");
        suggestionsBox.innerHTML = "";
        return;
      }

      suggestionsBox.innerHTML = "";
      results.forEach(tag => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-sm btn-outline-secondary m-1";
        btn.textContent = "#" + tag.name;
        btn.addEventListener("click", function() {
          let current = tagsInput.value || "";

          // Split into tags by comma, trim whitespace, drop empty fragments
          let parts = current.split(/,/).map(p => p.trim()).filter(Boolean);

          if (parts.length === 0) {
            // No existing tags, just insert this one
            parts = [tag.name];
          } else {
            // Replace the last (partial) tag with the selected suggestion
            parts[parts.length - 1] = tag.name;
          }

          // Join back and add ", " so the user can type the next tag easily
          tagsInput.value = parts.join(", ") + ", ";
          tagsInput.focus();

          // Hide suggestions after selecting
          suggestionsBox.classList.add("d-none");
          suggestionsBox.innerHTML = "";
        });

        suggestionsBox.appendChild(btn);
      });
      suggestionsBox.classList.remove("d-none");
    })
    .catch(() => {
      suggestionsBox.classList.add("d-none");
    });
  }

  if (tagsInput) {
    tagsInput.addEventListener("input", function() {
      const value = tagsInput.value;
      const lastPart = value.split(/[,#;]/).pop().trim();

      if (suggestionTimeout) {
        clearTimeout(suggestionTimeout);
      }
      suggestionTimeout = setTimeout(() => {
        fetchSuggestions(lastPart);
      }, 200);
    });
  }

  document.addEventListener("click", function(e) {
    if (suggestionsBox && !suggestionsBox.contains(e.target) && e.target !== tagsInput) {
      suggestionsBox.classList.add("d-none");
    }
  });

  // Title editing toggle
  const editTitleBtn = document.getElementById("edit-title-btn");
  const cancelTitleBtn = document.getElementById("cancel-title-btn");
  const titleDisplay = document.getElementById("meme-title-display");
  const titleEditForm = document.getElementById("title-edit-form");

  if (editTitleBtn) {
    editTitleBtn.addEventListener("click", function() {
      titleDisplay.classList.add("d-none");
      titleEditForm.classList.remove("d-none");
      titleEditForm.querySelector("input").focus();
    });
  }

  if (cancelTitleBtn) {
    cancelTitleBtn.addEventListener("click", function() {
      titleDisplay.classList.remove("d-none");
      titleEditForm.classList.add("d-none");
    });
  }
})();
</script>
{% endblock %}