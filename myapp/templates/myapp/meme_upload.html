{% extends "myapp/base.html" %}
{% load static %}

{% block title %}Upload meme{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h1 class="h5 mb-0">Upload a new meme</h1>
      </div>
      <div class="card-body">

        <form method="post" enctype="multipart/form-data" id="meme-upload-form">
          {% csrf_token %}

          <div class="mb-3">
            <label for="id_title" class="form-label">Title</label>
            {{ form.title }}
            {% if form.title.errors %}
              <div class="invalid-feedback d-block">
                {{ form.title.errors|striptags }}
              </div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">Image or Video</label>
            <div id="upload-dropzone" class="border border-secondary-subtle rounded-3 p-4 text-center bg-body-tertiary">
              <p class="mb-1">Click to select a file, drag & drop, or paste from clipboard.</p>
              <p class="text-muted small mb-0">Supported: images and videos.</p>
              <input type="file" name="file" id="id_file" class="d-none">
              <button type="button" class="btn btn-outline-secondary mt-3" id="select-file-btn">
                Choose file
              </button>
            </div>
            {% if form.file.errors %}
              <div class="invalid-feedback d-block">
                {{ form.file.errors|striptags }}
              </div>
            {% endif %}

            <div class="mt-3 d-none" id="file-preview-wrapper">
              <label class="form-label">Preview</label>
              <div id="file-preview" class="border rounded-3 p-3 bg-dark text-center"></div>
            </div>
          </div>

          <div class="mb-3">
            <label for="id_tags_input" class="form-label">Tags</label>
            <div class="position-relative">
              {{ form.tags_input }}
              <div id="tag-suggestions"
                class="position-absolute w-100 bg-body border border-secondary-subtle mt-1 rounded-3 shadow-sm d-none"
                style="z-index: 1000;"></div>
            </div>
            <div class="form-text">
              Type tags and separate with comma. Youâ€™ll get suggestions while typing.
            </div>
            {% if form.tags_input.errors %}
              <div class="invalid-feedback d-block">
                {{ form.tags_input.errors|striptags }}
              </div>
            {% endif %}
          </div>

          <!--<div class="mb-3">
            <label for="id_album" class="form-label">Album (optional)</label>
            {{ form.album }}
            {% if form.album.errors %}
              <div class="invalid-feedback d-block">
                {{ form.album.errors|striptags }}
              </div>
            {% endif %}
          </div>-->

          <div class="d-flex justify-content-between">
            <a href="{% url 'myapp:meme_list' %}" class="btn btn-outline-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const fileInput = document.getElementById("id_file");
    const dropzone = document.getElementById("upload-dropzone");
    const selectBtn = document.getElementById("select-file-btn");
    const previewWrapper = document.getElementById("file-preview-wrapper");
    const preview = document.getElementById("file-preview");
    const tagsInput = document.getElementById("id_tags_input");
    const suggestionsBox = document.getElementById("tag-suggestions");

    // disable browser autocomplete / helpers
    if (tagsInput) {
    tagsInput.setAttribute("autocomplete", "off");
    tagsInput.setAttribute("autocorrect", "off");
    tagsInput.setAttribute("autocapitalize", "off");
    tagsInput.setAttribute("spellcheck", "false");
    }

    function setFiles(files) {
      if (!files || files.length === 0) {
        return;
      }
      const dt = new DataTransfer();
      dt.items.add(files[0]);
      fileInput.files = dt.files;
      showPreview(files[0]);
    }

    function showPreview(file) {
      preview.innerHTML = "";
      previewWrapper.classList.remove("d-none");

      const type = file.type || "";

      if (type.startsWith("image/")) {
        const img = document.createElement("img");
        img.className = "img-fluid rounded";
        img.alt = file.name;
        img.src = URL.createObjectURL(file);
        preview.appendChild(img);
      } else if (type.startsWith("video/")) {
        const video = document.createElement("video");
        video.className = "w-100 rounded";
        video.controls = true;
        video.muted = true;
        const src = document.createElement("source");
        src.src = URL.createObjectURL(file);
        video.appendChild(src);
        preview.appendChild(video);
      } else {
        preview.textContent = file.name;
      }
    }

    selectBtn.addEventListener("click", function() {
      fileInput.click();
    });

    fileInput.addEventListener("change", function(e) {
      if (e.target.files && e.target.files.length > 0) {
        showPreview(e.target.files[0]);
      }
    });

    // drag & drop
    ["dragenter", "dragover"].forEach(eventName => {
      dropzone.addEventListener(eventName, function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add("border-primary");
      });
    });

    ["dragleave", "drop"].forEach(eventName => {
      dropzone.addEventListener(eventName, function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove("border-primary");
      });
    });

    dropzone.addEventListener("drop", function(e) {
      const files = e.dataTransfer.files;
      setFiles(files);
    });

    // paste support
    document.addEventListener("paste", function(e) {
      const items = e.clipboardData && e.clipboardData.items;
      if (!items) return;

      for (const item of items) {
        if (item.kind === "file") {
          const file = item.getAsFile();
          if (file) {
            setFiles([file]);
            break;
          }
        }
      }
    });

    // tag suggestions
    let suggestionTimeout = null;

    function fetchSuggestions(query) {
      if (!query) {
        suggestionsBox.classList.add("d-none");
        suggestionsBox.innerHTML = "";
        return;
      }

      const url = "{% url 'myapp:tag_suggestions' %}?q=" + encodeURIComponent(query);
      fetch(url, {
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(res => res.json())
      .then(data => {
        const results = data.results || [];
        if (!results.length) {
          suggestionsBox.classList.add("d-none");
          suggestionsBox.innerHTML = "";
          return;
        }

        suggestionsBox.innerHTML = "";
        results.forEach(tag => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-sm btn-outline-secondary m-1";
          btn.textContent = "#" + tag.name;
          btn.addEventListener("click", function() {
            let current = tagsInput.value || "";

            // split into tags by comma, trim whitespace, drop empty fragments
            let parts = current.split(/,/).map(p => p.trim()).filter(Boolean);

            if (parts.length === 0) {
                // no existing tags, just insert this one
                parts = [tag.name];
            } else {
                // replace the last (partial) tag with the selected suggestion
                parts[parts.length - 1] = tag.name;
            }

            // join back and add ", " so the user can type the next tag easily
            tagsInput.value = parts.join(", ") + ", ";
            tagsInput.focus();

            // hide suggestions after selecting
            suggestionsBox.classList.add("d-none");
            suggestionsBox.innerHTML = "";
            });

          suggestionsBox.appendChild(btn);
        });
        suggestionsBox.classList.remove("d-none");
      })
      .catch(() => {
        suggestionsBox.classList.add("d-none");
      });
    }

    tagsInput.addEventListener("input", function() {
      const value = tagsInput.value;
      const lastPart = value.split(/[,#;]/).pop().trim();

      if (suggestionTimeout) {
        clearTimeout(suggestionTimeout);
      }
      suggestionTimeout = setTimeout(() => {
        fetchSuggestions(lastPart);
      }, 200);
    });

    document.addEventListener("click", function(e) {
      if (!suggestionsBox.contains(e.target) && e.target !== tagsInput) {
        suggestionsBox.classList.add("d-none");
      }
    });
  })();
</script>
{% endblock %}
